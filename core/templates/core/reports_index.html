{% extends "core/base.html" %}
{% block title %}Report PDF / Excel{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h4 mb-0">Report</h1>
      <div class="text-muted small">Esporta in PDF o Excel con filtri</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'reports_index' %}">Pulisci filtri</a>
    </div>
  </div>

  <!-- =========================
       APPUNTAMENTI
  ========================== -->
  <div class="card mb-3">
    <div class="card-header fw-semibold d-flex align-items-center justify-content-between">
      <span>Appuntamenti</span>
      <span class="text-muted small">PDF / Excel</span>
    </div>
    <div class="card-body">
      <form class="row g-2 align-items-end" method="get" action="{% url 'report_appointments' %}" id="apptForm">
        <div class="col-12 col-md-3">
          <label class="form-label small text-muted">Dal</label>
          <input type="date" class="form-control" name="from" id="apptFrom">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label small text-muted">Al</label>
          <input type="date" class="form-control" name="to" id="apptTo">
        </div>

        {% if agents %}
        <div class="col-12 col-md-3">
          <label class="form-label small text-muted">Agente</label>
          <select class="form-select" id="apptAgent">
            <option value="">Tutti</option>
            {% for a in agents %}
              <option value="{{ a.id }}">{{ a.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <div class="col-12 col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary" name="format" value="pdf">PDF</button>
          <button type="submit" class="btn btn-outline-primary" name="format" value="xlsx">Excel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- =========================
       TODO
  ========================== -->
  <div class="card mb-3">
    <div class="card-header fw-semibold d-flex align-items-center justify-content-between">
      <span>Todo</span>
      <span class="text-muted small">PDF / Excel</span>
    </div>
    <div class="card-body">
      <form class="row g-2 align-items-end" method="get" action="{% url 'report_todos' %}" id="todoForm">
        <div class="col-12 col-md-3">
          <label class="form-label small text-muted">Stato</label>
          <select class="form-select" name="status" id="todoStatus">
            <option value="open">Aperte</option>
            <option value="done">Chiuse</option>
            <option value="all">Tutte</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label small text-muted">Dal</label>
          <input type="date" class="form-control" name="from">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label small text-muted">Al</label>
          <input type="date" class="form-control" name="to">
        </div>

        {% if agents %}
        <div class="col-12 col-md-1">
          <label class="form-label small text-muted">Agente</label>
          <select class="form-select" id="todoAgent">
            <option value="">Tutti</option>
            {% for a in agents %}
              <option value="{{ a.id }}">{{ a.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <div class="col-12 col-md-2 d-flex gap-2">
          <button type="submit" class="btn btn-primary" name="format" value="pdf">PDF</button>
          <button type="submit" class="btn btn-outline-primary" name="format" value="xlsx">Excel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- =========================
       IMMOBILI
  ========================== -->
  <div class="card">
    <div class="card-header fw-semibold d-flex align-items-center justify-content-between">
      <span>Immobili</span>
      <span class="text-muted small">PDF / Excel</span>
    </div>
    <div class="card-body">
      <form class="row g-2 align-items-end" method="get" action="{% url 'report_properties' %}">
        <div class="col-12 col-md-3">
          <label class="form-label small text-muted">Città (contiene)</label>
          <input type="text" class="form-control" name="city" placeholder="Es. Roma">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label small text-muted">Testo nella descrizione</label>
          <input type="text" class="form-control" name="description" placeholder="Es. giardino, ristrutturato…">
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label small text-muted">Prezzo min</label>
          <input type="number" step="0.01" class="form-control" name="price_min" placeholder="0">
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label small text-muted">Prezzo max</label>
          <input type="number" step="0.01" class="form-control" name="price_max" placeholder="999999">
        </div>

        <div class="col-12 col-md-3 d-flex align-items-center gap-2">
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" name="has_photo" id="hasPhoto" value="1">
            <label class="form-check-label" for="hasPhoto">Solo con foto</label>
          </div>
        </div>

        <div class="col-12 col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary" name="format" value="pdf">PDF</button>
          <button type="submit" class="btn btn-outline-primary" name="format" value="xlsx">Excel</button>
        </div>

        <div class="col-12">
          <div class="text-muted small">
            PDF: include miniature. Excel: colonne complete + “Ha foto?”.
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  // Appuntamenti: se admin seleziona agente -> cambia action del form (/appointments/<id>/)
  const apptForm = document.getElementById("apptForm");
  const apptAgent = document.getElementById("apptAgent");
  if (apptForm && apptAgent){
    const base = apptForm.getAttribute("action"); // /crm/reports/appointments/
    apptAgent.addEventListener("change", function(){
      const id = this.value;
      apptForm.setAttribute("action", id ? (base + id + "/") : base);
    });
  }

  // Todo: se admin seleziona agente -> cambia action (/todos/<id>/)
  const todoForm = document.getElementById("todoForm");
  const todoAgent = document.getElementById("todoAgent");
  if (todoForm && todoAgent){
    const base = todoForm.getAttribute("action"); // /crm/reports/todos/
    todoAgent.addEventListener("change", function(){
      const id = this.value;
      todoForm.setAttribute("action", id ? (base + id + "/") : base);
    });
  }
})();
</script>
{% endblock %}
