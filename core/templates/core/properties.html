{% extends "core/base.html" %}
{% block title %}Immobili{% endblock %}

{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <h1 class="h4 mb-0">Immobili</h1>
  {% if request.user.is_staff or request.user.is_superuser %}
    <a class="btn btn-primary" href="{% url 'property_add' %}">+ Nuovo immobile</a>
  {% endif %}
</div>

{% if properties and properties|length > 0 %}

  {# =========================
     MOBILE (cards)  < md
     ========================= #}
  <div class="d-md-none">
    <div class="d-flex flex-column gap-2">
      {% for p in properties %}
        {% with full_desc=p.description|default:"" %}
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div class="min-w-0">
                <div class="fw-semibold">
                  {{ p.code|default:"(senza codice)" }}
                </div>

                <div class="text-muted small">
                  {% if p.city %}{{ p.city }}{% endif %}
                  {% if p.address %}
                    {% if p.city %} • {% endif %}
                    {{ p.address }}
                  {% endif %}
                </div>

                {% if full_desc %}
                  <div class="mt-2">
                    <span
                      class="d-inline-block text-truncate"
                      style="max-width: 100%;"
                      data-bs-toggle="tooltip"
                      data-bs-title="{{ full_desc }}"
                    >
                      {{ full_desc|truncatechars:110 }}
                    </span>
                  </div>
                {% endif %}

                <div class="mt-2">
                  {% if p.price %}
                    <span class="badge bg-light text-dark border">€ {{ p.price }}</span>
                  {% else %}
                    <span class="badge bg-light text-muted border">—</span>
                  {% endif %}
                </div>
              </div>

              <div class="d-flex flex-column gap-2">
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'property_detail' p.pk %}">Apri</a>
                {% if request.user.is_staff or request.user.is_superuser %}
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'property_edit' p.pk %}">Modifica</a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>
  </div>

  {# =========================
     DESKTOP/TABLET (table) >= md
     ========================= #}
  <div class="d-none d-md-block">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Codice</th>
            <th>Città</th>
            <th>Indirizzo</th>
            <th>Descrizione</th>
            <th class="text-end">Prezzo</th>
            <th style="width: 210px;"></th>
          </tr>
        </thead>
        <tbody>
          {% for p in properties %}
            {% with full_desc=p.description|default:"" %}
            <tr>
              <td class="fw-semibold">{{ p.code|default:"" }}</td>
              <td>{{ p.city|default:"" }}</td>
              <td>{{ p.address|default:"" }}</td>

              <td>
                {% if full_desc %}
                  <span
                    class="d-inline-block text-truncate"
                    style="max-width: 420px;"
                    data-bs-toggle="tooltip"
                    data-bs-title="{{ full_desc }}"
                  >
                    {{ full_desc|truncatechars:80 }}
                  </span>
                {% endif %}
              </td>

              <td class="text-end">
                {% if p.price %}€ {{ p.price }}{% else %}<span class="text-muted">—</span>{% endif %}
              </td>

              <td class="text-end">
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'property_detail' p.pk %}">Apri</a>
                {% if request.user.is_staff or request.user.is_superuser %}
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'property_edit' p.pk %}">Modifica</a>
                {% endif %}
              </td>
            </tr>
            {% endwith %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

{% else %}
  <div class="alert alert-info">Nessun immobile presente.</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Tooltip Bootstrap 5
    const els = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    els.forEach(function (el) {
      new bootstrap.Tooltip(el);
    });
  });
</script>
{% endblock %}
