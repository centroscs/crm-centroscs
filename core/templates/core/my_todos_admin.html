{% extends "core/base.html" %}
{% block title %}Todo — Le mie{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Todo — Le mie</h2>
</div>

{% if not agents %}
  <div class="alert alert-warning">Nessun agente trovato.</div>
{% else %}
  <div class="accordion" id="agentsAccordion">
    {% for a in agents %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ a.id }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ a.id }}" aria-expanded="false" aria-controls="collapse{{ a.id }}">
            <strong>{{ a.name }}</strong>
          </button>
        </h2>
        <div id="collapse{{ a.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ a.id }}" data-bs-parent="#agentsAccordion">
          <div class="accordion-body">
            <div class="mb-2">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'agent_todos' a.pk %}">Apri gestione completa</a>
              <a class="btn btn-sm btn-primary" href="{% url 'agent_todo_new' a.pk %}">+ Nuova todo</a>
            </div>

            {% with todos=a.todos.all %}
              {% if not todos %}
                <div class="text-muted">Nessuna todo per questo agente.</div>
              {% else %}
                <ul class="list-group">
                  {% for t in todos %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <div class="fw-semibold">{{ t.title }}</div>
                        {% if t.due_date %}
                          <small class="text-muted">Scadenza: {{ t.due_date }}</small>
                        {% endif %}
                      </div>
                      <div class="d-flex gap-2 align-items-center">
                        {% if t.completed %}
                          <span class="badge bg-success">CHIUSA</span>
                          <a class="btn btn-sm btn-success" href="{% url 'todo_toggle' t.pk %}">Riapri</a>
                        {% else %}
                          <span class="badge bg-danger">APERTA</span>
                          <a class="btn btn-sm btn-danger" href="{% url 'todo_toggle' t.pk %}">Chiudi</a>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            {% endwith %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}
{% endblock %}
