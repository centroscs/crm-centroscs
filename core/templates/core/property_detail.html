{% extends "core/base.html" %}
{% block title %}Immobile {{ property.code }}{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-0">Immobile {{ property.code }}</h1>
    <div style="opacity:.75;">
      {{ property.code }}
      {% if property.description %} — {{ property.description }}
      {% elif property.title %} — {{ property.title }}
      {% endif %}
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'properties_list' %}">Indietro</a>
    {% if request.user.is_staff or request.user.is_superuser %}
      <a class="btn btn-primary" href="{% url 'property_edit' property.pk %}">Modifica</a>
    {% endif %}
  </div>
</div>

{# ===================== DATI IMMOBILE ===================== #}
<div class="card mb-3">
  <div class="card-body p-0">
    <table class="table table-sm mb-0">
      <tr>
        <th style="width:180px;">Codice</th>
        <td>{{ property.code }}</td>
      </tr>
      <tr>
        <th>Descrizione</th>
        <td>{% firstof property.description property.title "" %}</td>
      </tr>
      <tr>
        <th>Città</th>
        <td>{{ property.city|default:"" }}</td>
      </tr>
      <tr>
        <th>Indirizzo</th>
        <td>{{ property.address|default:"" }}</td>
      </tr>
      <tr>
        <th>Prezzo</th>
        <td>
          {% if property.price %}
            € {{ property.price }}
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>
      </tr>
    </table>
  </div>
</div>

{# ===================== FOTO ===================== #}
<div class="card mb-4">
  <div class="card-header">
    <strong>Foto immobile</strong>
  </div>
  <div class="card-body">
    {% if images %}
      <div class="d-flex flex-wrap gap-2">
        {% for img in images %}
          <a href="{{ img.image.url }}" target="_blank">
            <img src="{{ img.image.url }}"
                 style="width:140px;height:140px;object-fit:cover;border-radius:10px;
                        {% if img.is_primary %}outline:3px solid #0d6efd;{% endif %}">
          </a>
        {% endfor %}
      </div>
      <div class="small mt-2 text-muted">
        L’immagine con bordo blu è la <b>principale</b>.
      </div>
    {% else %}
      <div class="text-muted">Nessuna foto caricata.</div>
    {% endif %}
  </div>
</div>

{# ===================== MAPPA ===================== #}
{% with addr=property.address|default:"" city=property.city|default:"" %}
  {% with full_address=addr|add:" "|add:city %}
    {% if addr or city %}
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>Posizione</strong>
          <a class="btn btn-sm btn-outline-primary"
             href="https://www.google.com/maps/search/?api=1&query={{ full_address|urlencode }}"
             target="_blank" rel="noopener">
            Apri su Google Maps
          </a>
        </div>
        <div class="card-body p-0">
          <iframe
            width="100%"
            height="360"
            style="border:0;border-bottom-left-radius:12px;border-bottom-right-radius:12px;"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps?q={{ full_address|urlencode }}&output=embed">
          </iframe>
        </div>
        <div class="card-footer small text-muted">
          Se l’indirizzo è incompleto, la mappa può “indovinare” male. Usa “Apri su Google Maps” per verificare.
        </div>
      </div>
    {% endif %}
  {% endwith %}
{% endwith %}

{% endblock %}
