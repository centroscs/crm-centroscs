{% extends "core/base.html" %}
{% block title %}Immobile {{ property.code }}{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-0">Immobile {{ property.code }}</h1>
    <div style="opacity:.75;">
      {{ property.code }}
      {% if property.description %} — {{ property.description }}{% elif property.title %} — {{ property.title }}{% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'properties_list' %}">Indietro</a>
    <a class="btn btn-primary" href="{% url 'property_edit' property.pk %}">Modifica</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-7">

    {# --- FOTO PRINCIPALE (prima in images grazie a ordering -is_primary,id) --- #}
    {% with main=images|first %}
      <div class="card">
        <div class="card-body p-2">
          {% if main and main.image %}
            <img src="{{ main.image.url }}"
                 class="w-100"
                 style="height:420px;object-fit:cover;border-radius:16px;cursor:zoom-in;"
                 data-lightbox-src="{{ main.image.url }}"
                 alt="Foto principale">
          {% else %}
            <div class="d-flex align-items-center justify-content-center text-muted"
                 style="height:420px;border-radius:16px;background:rgba(0,0,0,.03);">
              Nessuna foto caricata
            </div>
          {% endif %}
        </div>
      </div>
    {% endwith %}

    {# --- GALLERIA THUMBS --- #}
    {% if images and images|length > 0 %}
      <div class="card mt-3">
        <div class="card-header">
          <strong>Galleria foto</strong>
          <span class="text-muted small ms-2">Clicca per ingrandire</span>
        </div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2">
            {% for img in images %}
              {% if img.image %}
                <div class="position-relative" style="width:92px;height:92px;">
                  <img src="{{ img.image.url }}"
                       style="width:92px;height:92px;object-fit:cover;border-radius:14px;cursor:zoom-in;{% if img.is_primary %}outline:3px solid #0d6efd;{% endif %}"
                       data-lightbox-src="{{ img.image.url }}"
                       alt="Foto immobile">
                  {% if img.is_primary %}
                    <span class="badge bg-primary position-absolute" style="top:6px;left:6px;">P</span>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}

  </div>

  <div class="col-12 col-lg-5">
    <div class="card">
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <tr>
            <th style="width: 180px;">Codice</th>
            <td>{{ property.code }}</td>
          </tr>
          <tr>
            <th>Descrizione</th>
            <td>{% firstof property.description property.title "" %}</td>
          </tr>
          <tr>
            <th>Città</th>
            <td>{{ property.city|default:"" }}</td>
          </tr>
          <tr>
            <th>Indirizzo</th>
            <td>{{ property.address|default:"" }}</td>
          </tr>
          <tr>
            <th>Prezzo</th>
            <td>{% if property.price %}€ {{ property.price }}{% else %}<span class="text-muted">—</span>{% endif %}</td>
          </tr>
        </table>
      </div>
    </div>

    {# opzionale: appuntamenti collegati, se li usi già nel progetto #}
    {% if property.appointments.all %}
      {% with appts=property.appointments.all %}
        {% if appts|length > 0 %}
          <div class="card mt-3">
            <div class="card-header"><strong>Appuntamenti collegati</strong></div>
            <div class="card-body">
              <ul class="list-unstyled mb-0">
                {% for a in appts %}
                  <li class="mb-2">
                    <a href="{% url 'appointment_detail' a.pk %}">{{ a.title }}</a>
                    <div class="text-muted small">
                      {{ a.start }}{% if a.end %} → {{ a.end }}{% endif %}
                    </div>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endif %}
      {% endwith %}
    {% endif %}
  </div>
</div>

{# ---------------- LIGHTBOX ---------------- #}
<div id="lightbox"
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;align-items:center;justify-content:center;padding:24px;">
  <img id="lightboxImg" src="" style="max-width:95vw;max-height:90vh;border-radius:16px;">
</div>

<script>
  (function() {
    const lb = document.getElementById("lightbox");
    const lbImg = document.getElementById("lightboxImg");
    if (!lb || !lbImg) return;

    function openLB(src) {
      lbImg.src = src;
      lb.style.display = "flex";
    }
    function closeLB() {
      lb.style.display = "none";
      lbImg.src = "";
    }

    document.querySelectorAll("[data-lightbox-src]").forEach(el => {
      el.addEventListener("click", () => openLB(el.getAttribute("data-lightbox-src")));
    });

    lb.addEventListener("click", closeLB);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeLB();
    });
  })();
</script>
{% endblock %}
